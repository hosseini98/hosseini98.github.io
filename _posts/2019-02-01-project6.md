---
title: "Data Cleaning: Consumer Complaint Database "
date: 2019-02-01
tags: [Data Cleaning, Python, visualization]
header: 
    image: "/images/waterfront.jpg"
excerpt: "Data Cleaning, Python"
mathjax: "true"
---

Here, I will clean data from Financial Services Consumer Complaint Database which is publicly avalable in this [link](https://catalog.data.gov/dataset/consumer-complaint-database#topic=consumer_navigation). As described in this webpage, it contains "data from the complaints received by the Consumer Financial Protection Bureau (CFPB) on financial products and services, including bank accounts, credit cards, credit reporting, debt collection, money transfers, mortgages, student loans, and other types of consumer credit. Data available about each complaint includes the name of the provider, type of complaint, date, zip code, and other information."





## Data cleaning


```python
import pandas as pd
import numpy as np
import os
df = pd.read_csv("Consumer_Complaints.csv")
```

```python
df.head()

```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date received</th>
      <th>Product</th>
      <th>Sub-product</th>
      <th>Issue</th>
      <th>Sub-issue</th>
      <th>Consumer complaint narrative</th>
      <th>Company public response</th>
      <th>Company</th>
      <th>State</th>
      <th>ZIP code</th>
      <th>Tags</th>
      <th>Consumer consent provided?</th>
      <th>Submitted via</th>
      <th>Date sent to company</th>
      <th>Company response to consumer</th>
      <th>Timely response?</th>
      <th>Consumer disputed?</th>
      <th>Complaint ID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>02/04/2019</td>
      <td>Credit card or prepaid card</td>
      <td>General-purpose credit card or charge card</td>
      <td>Getting a credit card</td>
      <td>Sent card you never applied for</td>
      <td>NaN</td>
      <td>Company believes it acted appropriately as aut...</td>
      <td>First Federal Credit Control</td>
      <td>FL</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Web</td>
      <td>02/04/2019</td>
      <td>Closed with explanation</td>
      <td>Yes</td>
      <td>NaN</td>
      <td>3141563</td>
    </tr>
    <tr>
      <th>1</th>
      <td>02/04/2019</td>
      <td>Debt collection</td>
      <td>Payday loan debt</td>
      <td>False statements or representation</td>
      <td>Attempted to collect wrong amount</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ONEMAIN FINANCIAL HOLDINGS, LLC.</td>
      <td>MI</td>
      <td>NaN</td>
      <td>Older American</td>
      <td>NaN</td>
      <td>Web</td>
      <td>02/04/2019</td>
      <td>In progress</td>
      <td>Yes</td>
      <td>NaN</td>
      <td>3141667</td>
    </tr>
    <tr>
      <th>2</th>
      <td>02/04/2019</td>
      <td>Credit reporting, credit repair services, or o...</td>
      <td>Credit reporting</td>
      <td>Incorrect information on your report</td>
      <td>Information belongs to someone else</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NCC Business Services, Inc.</td>
      <td>TX</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Web</td>
      <td>02/04/2019</td>
      <td>In progress</td>
      <td>Yes</td>
      <td>NaN</td>
      <td>3142226</td>
    </tr>
    <tr>
      <th>3</th>
      <td>02/04/2019</td>
      <td>Mortgage</td>
      <td>Conventional home mortgage</td>
      <td>Struggling to pay mortgage</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>BAYVIEW LOAN SERVICING, LLC</td>
      <td>CA</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Other</td>
      <td>Web</td>
      <td>02/04/2019</td>
      <td>In progress</td>
      <td>Yes</td>
      <td>NaN</td>
      <td>3142610</td>
    </tr>
    <tr>
      <th>4</th>
      <td>02/04/2019</td>
      <td>Debt collection</td>
      <td>I do not know</td>
      <td>Attempts to collect debt not owed</td>
      <td>Debt was paid</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Diversified Consultants, Inc.</td>
      <td>OH</td>
      <td>45044</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Web</td>
      <td>02/04/2019</td>
      <td>In progress</td>
      <td>Yes</td>
      <td>NaN</td>
      <td>3141862</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.shape
```




    (1210607, 18)




```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 1210607 entries, 0 to 1210606
    Data columns (total 18 columns):
    Date received                   1210607 non-null object
    Product                         1210607 non-null object
    Sub-product                     975441 non-null object
    Issue                           1210607 non-null object
    Sub-issue                       688720 non-null object
    Consumer complaint narrative    364203 non-null object
    Company public response         413021 non-null object
    Company                         1210607 non-null object
    State                           1193509 non-null object
    ZIP code                        1105732 non-null object
    Tags                            165229 non-null object
    Consumer consent provided?      645754 non-null object
    Submitted via                   1210607 non-null object
    Date sent to company            1210607 non-null object
    Company response to consumer    1210601 non-null object
    Timely response?                1210607 non-null object
    Consumer disputed?              768520 non-null object
    Complaint ID                    1210607 non-null int64
    dtypes: int64(1), object(17)
    memory usage: 166.3+ MB



```python
df.isnull().sum()
```




    Date received                         0
    Product                               0
    Sub-product                      235166
    Issue                                 0
    Sub-issue                        521887
    Consumer complaint narrative     846404
    Company public response          797586
    Company                               0
    State                             17098
    ZIP code                         104875
    Tags                            1045378
    Consumer consent provided?       564853
    Submitted via                         0
    Date sent to company                  0
    Company response to consumer          6
    Timely response?                      0
    Consumer disputed?               442087
    Complaint ID                          0
    dtype: int64




```python
df["Date received"] = pd.to_datetime(df["Date received"])
df['Date sent to company'] = pd.to_datetime(df['Date sent to company'])

```


```python
def convert_type_to_int(val):
    """
    Convert the type from object to int
    """
    return int(val)


df['Complaint ID'].apply(convert_type_to_int)

```


```python
df["Timely response?"] = np.where(df["Timely response?"] == "Yes", True, False)
df["Consumer disputed?"] = np.where(df["Consumer disputed?"] == "Yes", True, False)
df["Consumer consent provided?"] = np.where(df["Consumer consent provided?"] == "Consent not provided", False, True)
```


```python
def replace_ZIP_code_XX(x):
    '''
    Replace XX in Zip code to 00
    '''
    try: 
        return x.replace('XX', '00').replace('(','').replace('"','').replace('-','').replace('$','').replace('.','').replace('!','').replace('+','').replace('*','').replace('`','').replace('/','')
    except AttributeError:
        return np.NaN

df['ZIP code'] = df['ZIP code'].map(replace_ZIP_code_XX)

```


```python
df.dtypes.to_frame(name='Type')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Date received</th>
      <td>datetime64[ns]</td>
    </tr>
    <tr>
      <th>Product</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Sub-product</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Issue</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Sub-issue</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Consumer complaint narrative</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Company public response</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Company</th>
      <td>object</td>
    </tr>
    <tr>
      <th>State</th>
      <td>object</td>
    </tr>
    <tr>
      <th>ZIP code</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Tags</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Consumer consent provided?</th>
      <td>bool</td>
    </tr>
    <tr>
      <th>Submitted via</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Date sent to company</th>
      <td>datetime64[ns]</td>
    </tr>
    <tr>
      <th>Company response to consumer</th>
      <td>object</td>
    </tr>
    <tr>
      <th>Timely response?</th>
      <td>bool</td>
    </tr>
    <tr>
      <th>Consumer disputed?</th>
      <td>bool</td>
    </tr>
    <tr>
      <th>Complaint ID</th>
      <td>int64</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 1210607 entries, 0 to 1210606
    Data columns (total 18 columns):
    Date received                   1210607 non-null datetime64[ns]
    Product                         1210607 non-null object
    Sub-product                     975441 non-null object
    Issue                           1210607 non-null object
    Sub-issue                       688720 non-null object
    Consumer complaint narrative    364203 non-null object
    Company public response         413021 non-null object
    Company                         1210607 non-null object
    State                           1193509 non-null object
    ZIP code                        1105732 non-null object
    Tags                            165229 non-null object
    Consumer consent provided?      1210607 non-null bool
    Submitted via                   1210607 non-null object
    Date sent to company            1210607 non-null datetime64[ns]
    Company response to consumer    1210601 non-null object
    Timely response?                1210607 non-null bool
    Consumer disputed?              1210607 non-null bool
    Complaint ID                    1210607 non-null int64
    dtypes: bool(3), datetime64[ns](2), int64(1), object(12)
    memory usage: 142.0+ MB



```python
df2 = df
```


```python
df2['ZIP code'] = df2['ZIP code'].fillna("00000").astype(int)
df2['State'] = df2['State'].fillna("Not given")
df2['Product'] = df2['Product'].fillna("Not given")
df2['Sub-product'] = df2['Sub-product'].fillna("Not given")
df2['Issue'] = df2['Issue'].fillna("Not given")
df2['Sub-issue'] = df2['Sub-issue'].fillna("Not given")
df2['Consumer complaint narrative'] = df2['Consumer complaint narrative'].fillna("Not given")
df2['Company public response'] = df2['Company public response'].fillna("Not given")
df2['Company response to consumer'] = df2['Company response to consumer'].fillna("Not given")
df2['Tags'] = df2['Tags'].fillna("Not given")
```


```python
df2.dtypes
```




    Date received                   datetime64[ns]
    Product                                 object
    Sub-product                             object
    Issue                                   object
    Sub-issue                               object
    Consumer complaint narrative            object
    Company public response                 object
    Company                                 object
    State                                   object
    ZIP code                                 int64
    Tags                                    object
    Consumer consent provided?                bool
    Submitted via                           object
    Date sent to company            datetime64[ns]
    Company response to consumer            object
    Timely response?                          bool
    Consumer disputed?                        bool
    Complaint ID                             int64
    dtype: object





```python
df2.isnull().sum()
```




    Date received                   0
    Product                         0
    Sub-product                     0
    Issue                           0
    Sub-issue                       0
    Consumer complaint narrative    0
    Company public response         0
    Company                         0
    State                           0
    ZIP code                        0
    Tags                            0
    Consumer consent provided?      0
    Submitted via                   0
    Date sent to company            0
    Company response to consumer    0
    Timely response?                0
    Consumer disputed?              0
    Complaint ID                    0
    dtype: int64




```python
df2.columns = ['Date_received', 'Product', 'Sub_product', 'Issue', 'Sub_issue',
       'Consumer_complaint_narrative', 'Company_public_response', 'Company',
       'State', 'ZIP code', 'Tags', 'Consumer_consent_provided?',
       'Submitted_via', 'Date_sent_to_company', 'Company_response_to_consumer',
       'Timely_response?', 'Consumer_disputed?', 'Complaint_ID']
```


```python
df2.to_csv("Customer_Complaints_cleaned.csv", sep='\t', encoding='utf-8')
```


```python
cwd = os.getcwd()
cwd
```




    '/Users/hossein/Documents/GitHub/Udacity-Data-Analyst-Nanodegree'




```python



```

## Data vizualization


```python
import pandas as pd
from IPython.display import display
pd.options.display.max_columns = None
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
sns.set()
from scipy.spatial.distance import pdist, squareform
from scipy.cluster.hierarchy import linkage
from scipy.cluster.hierarchy import dendrogram
from sklearn.preprocessing import StandardScaler
import statsmodels.api as sm
import pylab as pl
#import scikitplot as skplt
from statsmodels.stats.outliers_influence import variance_inflation_factor
from sklearn.cluster import KMeans
from sklearn.metrics import silhouette_samples
from matplotlib import cm
import plotly.graph_objs as go
import plotly.offline as py
import os
from PIL import  Image
import io
py.init_notebook_mode(connected=True)
import plotly.tools as tls
import plotly.figure_factory as ff
import matplotlib.ticker as mtick
import scipy
```


<script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script><script type="text/javascript">if (window.MathJax) {MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}</script><script>requirejs.config({paths: { 'plotly': ['https://cdn.plot.ly/plotly-latest.min']},});if(!window._Plotly) {require(['plotly'],function(plotly) {window._Plotly=plotly;});}</script>



```python
%matplotlib inline
rcParams['figure.figsize'] = 28, 4
sb.set_style('whitegrid')
```



```python
Disputed_cunsumer_rate = (df2['Consumer_disputed?'].value_counts()*100.0 /len(df2)).plot(kind='pie',\
        labels = ['No', 'Yes'], figsize = (6,6) , colors = ['grey','red'])

Disputed_cunsumer_rate.set_title('Consumer disputed?')
Disputed_cunsumer_rate.legend(labels=['No','Yes']);
```


<img src="{{ site.url }}{{ site.baseurl }}/images/complaint/output_25_0.png" alt="output">



```python
Timely_response_rate = (df2['Timely_response?'].value_counts()*100.0 /len(df2)).plot(kind='pie',\
        labels = ['Yes', 'No'], figsize = (7,7) , colors = ['grey','green'])

Timely_response_rate.set_title('Timely response?')
Timely_response_rate.legend(labels=['Yes','No']);
```


<img src="{{ site.url }}{{ site.baseurl }}/images/complaint/output_26_0.png" alt="output">



```python
Consumer_consent_provided_rate = (df2['Consumer_consent_provided?'].value_counts()*100.0 /len(df2)).plot(kind='pie',\
        labels = ['Yes', 'No'], figsize = (7,7) , colors = ['grey','blue'])

Consumer_consent_provided_rate.set_title('Consumer consent provided?')
Consumer_consent_provided_rate.legend(labels=['Yes','No']);
```


<img src="{{ site.url }}{{ site.baseurl }}/images/complaint/output_27_0.png" alt="output">

```python
rcParams['figure.figsize'] = 28, 4
gb = df.groupby("State")["Submitted_via"].value_counts().to_frame().rename({"Submitted_via": "Number of complaints"}, axis = 1).reset_index()
sns.barplot(x = "State", y = "Number of complaints", data = gb, hue = "Submitted_via", palette = sns.color_palette("hls", 8)).set_title("Number of complaints in each state based on submission method");
plt.xticks(rotation=-90);
```
    
<img src="{{ site.url }}{{ site.baseurl }}/images/complaint/output_28_1.png" alt="output">


```python
gb = df.groupby("State")["Submitted_via"].value_counts().to_frame().rename({"Submitted_via": "Number of complaints"}, axis = 1).reset_index()
sns.barplot(x = "State", y = "Number of complaints", data = gb, hue = "Submitted_via", palette = sns.color_palette("hls", 8)).set_title("Number of complaints in each state based on submission method");
plt.xticks(rotation=-90);

```
    
<img src="{{ site.url }}{{ site.baseurl }}/images/complaint/output_29_1.png" alt="output">

```python
submission = (df['Submitted_via'].value_counts()*100.0 /len(df2)).plot(kind='pie',\
        figsize = (8,8) , colors = ['grey','purple', 'orange', 'green', 'blue', 'red'], fontsize = 15)

submission.set_title('Submission method ')
submission.legend(labels=['Web', 'Referral', 'Phone', 'Postal mail', 'Fax', 'Email']);
```

<img src="{{ site.url }}{{ site.baseurl }}/images/complaint/output_30_0.png" alt="output">

```python
product_info = (df2['Product'].value_counts()*100.0 /len(df2)).plot(kind='bar', stacked = True,\
                                                rot = 0, color = ['red','lightblue','green', 'blue', 'yellow'])
  
product_info.yaxis.set_major_formatter(mtick.PercentFormatter())
product_info.set_ylabel('Complaints')
product_info.set_xlabel('Product')
product_info.set_title('Percentage of complaints for each product');


<img src="{{ site.url }}{{ site.baseurl }}/images/complaint/output_31_0.png" alt="output">

plt.hist(tcc.tenure)
plt.xlabel('tenure')
plt.title("Tenure Distribution");
```


```python
df2["Company_public_response"] = np.where(df2["Company_public_response"] == "Not given", False, True)
```

```python
Company_public_response_rate = (df2['Company_public_response'].value_counts()*100.0 /len(df2)).plot(kind='pie',\
        labels = ['No', 'Yes'], figsize = (7,7) , colors = ['grey','blue'])

Company_public_response_rate.set_title('Company public response provided?')
Company_public_response_rate.legend(labels=['No','Yes']);

```
<img src="{{ site.url }}{{ site.baseurl }}/images/complaint/output_34_0.png" alt="output">



```python
rcParams['figure.figsize'] = 8, 6
plt.hist(date_delay, normed=True, bins=1000)
plt.ylabel('Probability');
plt.xlim((0, 40))

```


<img src="{{ site.url }}{{ site.baseurl }}/images/complaint/output_36_1.png" alt="output">
